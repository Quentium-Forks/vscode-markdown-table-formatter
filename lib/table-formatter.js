"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const vscode = require("vscode");
const regex_1 = require("./regex");
const format_table_1 = require("./format-table");
function getSettings() {
    let vscodeConfig = vscode.workspace.getConfiguration('markdown-table-formatter');
    return {
        formatOnSave: vscodeConfig.get('formatOnSave'),
        autoSelectEntireDocument: vscodeConfig.get('autoSelectEntireDocument'),
        spacePadding: vscodeConfig.get('spacePadding'),
        keepFirstAndLastPipes: vscodeConfig.get('keepFirstAndLastPipes'),
        defaultTableJustification: vscodeConfig.get('defaultTableJustification'),
        markdownGrammarScopes: vscodeConfig.get('markdownGrammarScopes'),
        limitLastColumnPadding: vscodeConfig.get('limitLastColumnPadding')
    };
}
class TableFormatter {
    format(editor, force = false) {
        const emptySelection = editor.selections.every(s => s.isEmpty);
        if (!getSettings().markdownGrammarScopes.includes(editor.document.languageId)) {
            return undefined;
        }
        if (force || (emptySelection && getSettings().autoSelectEntireDocument)) {
            let tables = this.tablesIn(editor.document);
            editor.edit(editBuilder => {
                tables.forEach(table => {
                    editBuilder.replace(table.range, format_table_1.formatTable(table.match, getSettings()));
                });
            });
        }
        else {
            let tables = this.tablesIn(editor.document, editor.selections);
            editor.edit(editBuilder => {
                tables.forEach(table => {
                    editBuilder.replace(table.range, format_table_1.formatTable(table.match, getSettings()));
                });
            });
        }
    }
    tablesIn(document, forRanges = []) {
        var items = [];
        if (forRanges.length === 0) {
            const firstLine = document.lineAt(0);
            const lastLine = document.lineAt(document.lineCount - 1);
            const textRange = new vscode.Range(0, firstLine.range.start.character, document.lineCount - 1, lastLine.range.end.character);
            forRanges.push(textRange);
        }
        forRanges.forEach(range => {
            const text = document.getText();
            let match = regex_1.tableRegex.exec(text);
            while (match !== null) {
                if (match) {
                    let start = document.positionAt(match.index);
                    let end = document.positionAt(match.index + match[0].length);
                    let nrange = new vscode.Range(start, end);
                    let r = nrange.intersection(range);
                    if (r) {
                        items.push({ match: match, range: r });
                    }
                }
                match = regex_1.tableRegex.exec(text);
            }
        });
        return items;
    }
}
exports.TableFormatter = TableFormatter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUtZm9ybWF0dGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3RhYmxlLWZvcm1hdHRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlDQUFpQztBQUNqQyxtQ0FBcUM7QUFDckMsaURBQTZDO0FBRzdDO0lBRUksSUFBSSxZQUFZLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0lBRWpGLE1BQU0sQ0FBQztRQUNILFlBQVksRUFBVyxZQUFZLENBQUMsR0FBRyxDQUFVLGNBQWMsQ0FBQztRQUNoRSx3QkFBd0IsRUFBVyxZQUFZLENBQUMsR0FBRyxDQUFVLDBCQUEwQixDQUFDO1FBQ3hGLFlBQVksRUFBVSxZQUFZLENBQUMsR0FBRyxDQUFTLGNBQWMsQ0FBQztRQUM5RCxxQkFBcUIsRUFBVyxZQUFZLENBQUMsR0FBRyxDQUFVLHVCQUF1QixDQUFDO1FBQ2xGLHlCQUF5QixFQUFVLFlBQVksQ0FBQyxHQUFHLENBQVMsMkJBQTJCLENBQUM7UUFDeEYscUJBQXFCLEVBQWUsWUFBWSxDQUFDLEdBQUcsQ0FBYyx1QkFBdUIsQ0FBQztRQUMxRixzQkFBc0IsRUFBVyxZQUFZLENBQUMsR0FBRyxDQUFVLHdCQUF3QixDQUFDO0tBQ3ZGLENBQUM7QUFDTixDQUFDO0FBRUQ7SUFDVyxNQUFNLENBQUMsTUFBeUIsRUFBRSxRQUFpQixLQUFLO1FBRTNELE1BQU0sY0FBYyxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRS9ELEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMscUJBQXFCLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzVFLE1BQU0sQ0FBQyxTQUFTLENBQUM7UUFDckIsQ0FBQztRQUNE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QUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztvQkFDM0MsQ0FBQztnQkFDTCxDQUFDO2dCQUNELEtBQUssR0FBRyxrQkFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNsQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLENBQUMsS0FBSyxDQUFDO0lBQ2pCLENBQUM7Q0FDSjtBQXpERCx3Q0F5REMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB2c2NvZGUgZnJvbSAndnNjb2RlJztcbmltcG9ydCB7IHRhYmxlUmVnZXggfSBmcm9tICcuL3JlZ2V4JztcbmltcG9ydCB7IGZvcm1hdFRhYmxlIH0gZnJvbSAnLi9mb3JtYXQtdGFibGUnO1xuaW1wb3J0IHsgTWFya2Rvd25UYWJsZUZvcm1hdHRlclNldHRpbmdzIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcblxuZnVuY3Rpb24gZ2V0U2V0dGluZ3MoKTogTWFya2Rvd25UYWJsZUZvcm1hdHRlclNldHRpbmdzIHtcbiAgICAvLyBUaGlzIGlwbGVtZW50YXRpb24gc2hvdWxkIGJlIG92ZXJyaWRlZCBmb3IgYW55IGN1c3RvbSBlZGl0b3IvcGxhdGZvcm0gdGhlIHBsdWdpbiBpcyB1c2VkXG4gICAgbGV0IHZzY29kZUNvbmZpZyA9IHZzY29kZS53b3Jrc3BhY2UuZ2V0Q29uZmlndXJhdGlvbignbWFya2Rvd24tdGFibGUtZm9ybWF0dGVyJyk7XG4gICAgLy8gRm9yY2luZyBjYXN0IGJlY2F1c2UgZGVmYXVsdHMgYXJlIGRlZmluZWQgaW4gcGFja2FnZXMuanNvbiwgc28gYWx3YXlzIGhhdmUgYSB2YWx1ZVxuICAgIHJldHVybiB7XG4gICAgICAgIGZvcm1hdE9uU2F2ZTogPGJvb2xlYW4+dnNjb2RlQ29uZmlnLmdldDxib29sZWFuPignZm9ybWF0T25TYXZlJyksXG4gICAgICAgIGF1dG9TZWxlY3RFbnRpcmVEb2N1bWVudDogPGJvb2xlYW4+dnNjb2RlQ29uZmlnLmdldDxib29sZWFuPignYXV0b1NlbGVjdEVudGlyZURvY3VtZW50JyksXG4gICAgICAgIHNwYWNlUGFkZGluZzogPG51bWJlcj52c2NvZGVDb25maWcuZ2V0PG51bWJlcj4oJ3NwYWNlUGFkZGluZycpLFxuICAgICAgICBrZWVwRmlyc3RBbmRMYXN0UGlwZXM6IDxib29sZWFuPnZzY29kZUNvbmZpZy5nZXQ8Ym9vbGVhbj4oJ2tlZXBGaXJzdEFuZExhc3RQaXBlcycpLFxuICAgICAgICBkZWZhdWx0VGFibGVKdXN0aWZpY2F0aW9uOiA8c3RyaW5nPnZzY29kZUNvbmZpZy5nZXQ8c3RyaW5nPignZGVmYXVsdFRhYmxlSnVzdGlmaWNhdGlvbicpLFxuICAgICAgICBtYXJrZG93bkdyYW1tYXJTY29wZXM6IDxTZXQ8c3RyaW5nPj52c2NvZGVDb25maWcuZ2V0PFNldDxzdHJpbmc+PignbWFya2Rvd25HcmFtbWFyU2NvcGVzJyksXG4gICAgICAgIGxpbWl0TGFzdENvbHVtblBhZGRpbmc6IDxib29sZWFuPnZzY29kZUNvbmZpZy5nZXQ8Ym9vbGVhbj4oJ2xpbWl0TGFzdENvbHVtblBhZGRpbmcnKVxuICAgIH07XG59XG5cbmV4cG9ydCBjbGFzcyBUYWJsZUZvcm1hdHRlciB7XG4gICAgcHVibGljIGZvcm1hdChlZGl0b3I6IHZzY29kZS5UZXh0RWRpdG9yLCBmb3JjZTogYm9vbGVhbiA9IGZhbHNlKSB7XG5cbiAgICAgICAgY29uc3QgZW1wdHlTZWxlY3Rpb24gPSBlZGl0b3Iuc2VsZWN0aW9ucy5ldmVyeShzID0+IHMuaXNFbXB0eSk7XG5cbiAgICAgICAgaWYgKCFnZXRTZXR0aW5ncygpLm1hcmtkb3duR3JhbW1hclNjb3Blcy5pbmNsdWRlcyhlZGl0b3IuZG9jdW1lbnQubGFuZ3VhZ2VJZCkpIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZvcmNlIHx8IChlbXB0eVNlbGVjdGlvbiAmJiBnZXRTZXR0aW5ncygpLmF1dG9TZWxlY3RFbnRpcmVEb2N1bWVudCkpIHtcbiAgICAgICAgICAgIGxldCB0YWJsZXM6IGFueVtdID0gdGhpcy50YWJsZXNJbihlZGl0b3IuZG9jdW1lbnQpO1xuICAgICAgICAgICAgZWRpdG9yLmVkaXQoZWRpdEJ1aWxkZXIgPT4ge1xuICAgICAgICAgICAgICAgIHRhYmxlcy5mb3JFYWNoKHRhYmxlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZWRpdEJ1aWxkZXIucmVwbGFjZSh0YWJsZS5yYW5nZSwgZm9ybWF0VGFibGUodGFibGUubWF0Y2gsIGdldFNldHRpbmdzKCkpKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGV0IHRhYmxlczogYW55W10gPSB0aGlzLnRhYmxlc0luKGVkaXRvci5kb2N1bWVudCwgZWRpdG9yLnNlbGVjdGlvbnMpO1xuICAgICAgICAgICAgZWRpdG9yLmVkaXQoZWRpdEJ1aWxkZXIgPT4ge1xuICAgICAgICAgICAgICAgIHRhYmxlcy5mb3JFYWNoKHRhYmxlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZWRpdEJ1aWxkZXIucmVwbGFjZSh0YWJsZS5yYW5nZSwgZm9ybWF0VGFibGUodGFibGUubWF0Y2gsIGdldFNldHRpbmdzKCkpKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHRhYmxlc0luKGRvY3VtZW50OiB2c2NvZGUuVGV4dERvY3VtZW50LCBmb3JSYW5nZXM6IHZzY29kZS5SYW5nZVtdID0gW10pIHtcbiAgICAgICAgdmFyIGl0ZW1zOiBhbnkgPSBbXTtcblxuICAgICAgICAvLyBUaGluayBpbiBhIHdheSB0byBvcHRpbWl6ZSB0aGlzXG4gICAgICAgIGlmIChmb3JSYW5nZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBjb25zdCBmaXJzdExpbmUgPSBkb2N1bWVudC5saW5lQXQoMCk7XG4gICAgICAgICAgICBjb25zdCBsYXN0TGluZSA9IGRvY3VtZW50LmxpbmVBdChkb2N1bWVudC5saW5lQ291bnQgLSAxKTtcbiAgICAgICAgICAgIGNvbnN0IHRleHRSYW5nZSA9IG5ldyB2c2NvZGUuUmFuZ2UoMCxcbiAgICAgICAgICAgICAgICBmaXJzdExpbmUucmFuZ2Uuc3RhcnQuY2hhcmFjdGVyLFxuICAgICAgICAgICAgICAgIGRvY3VtZW50LmxpbmVDb3VudCAtIDEsXG4gICAgICAgICAgICAgICAgbGFzdExpbmUucmFuZ2UuZW5kLmNoYXJhY3Rlcik7XG4gICAgICAgICAgICBmb3JSYW5nZXMucHVzaCh0ZXh0UmFuZ2UpO1xuICAgICAgICB9XG4gICAgICAgIGZvclJhbmdlcy5mb3JFYWNoKHJhbmdlID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBkb2N1bWVudC5nZXRUZXh0KCk7XG4gICAgICAgICAgICBsZXQgbWF0Y2ggPSB0YWJsZVJlZ2V4LmV4ZWModGV4dCk7XG4gICAgICAgICAgICB3aGlsZSAobWF0Y2ggIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN0YXJ0ID0gZG9jdW1lbnQucG9zaXRpb25BdChtYXRjaC5pbmRleCk7XG4gICAgICAgICAgICAgICAgICAgIGxldCBlbmQgPSBkb2N1bWVudC5wb3NpdGlvbkF0KG1hdGNoLmluZGV4ICsgbWF0Y2hbMF0ubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG5yYW5nZSA9IG5ldyB2c2NvZGUuUmFuZ2Uoc3RhcnQsIGVuZCk7XG4gICAgICAgICAgICAgICAgICAgIGxldCByID0gbnJhbmdlLmludGVyc2VjdGlvbihyYW5nZSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtcy5wdXNoKHsgbWF0Y2g6IG1hdGNoLCByYW5nZTogciB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBtYXRjaCA9IHRhYmxlUmVnZXguZXhlYyh0ZXh0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGl0ZW1zO1xuICAgIH1cbn0iXX0=